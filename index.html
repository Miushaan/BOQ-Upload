<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Inventory Viewer with MRN</title>
<style>
:root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.08)}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#e6eef6;font-size:13px;background:linear-gradient(180deg,#021124 0%,#071326 100%);}
.wrap{max-width:100%;margin:0 auto;padding:10px}
h1{text-align:center;font-size:1rem;margin:0 0 8px}
.card{background:var(--card);border-radius:10px;padding:10px;box-shadow:0 3px 12px rgba(0,0,0,0.5);}
.controls{display:flex;flex-direction:column;gap:8px}
.btn{background:linear-gradient(90deg,var(--accent),#7dd3fc);border:none;padding:8px;border-radius:8px;color:#021124;font-weight:600;cursor:pointer;font-size:0.9rem;text-align:center}
input[type="file"]{display:none}
.search{position:relative}
.search input{width:100%;padding:12px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:var(--glass);color:inherit;font-size:1rem;}
.table-wrap{margin-top:10px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:0.8rem}
th,td{padding:6px 5px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05);word-wrap:break-word;white-space:normal;}
th{color:var(--muted);font-weight:600;position:sticky;top:0;background:var(--card);z-index:1}
mark{background:rgba(6,182,212,0.3);color:#fff;border-radius:2px;padding:0 1px}
.unique-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.unique-item{background:rgba(6,182,212,0.2);padding:6px 10px;border-radius:6px;cursor:pointer;user-select:none;}
.zero-balance{color:red;font-weight:600;}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>📊 Inventory Viewer (BOQ Only)</h1>
  <div class="card">
    <div class="controls">
      <label id="upload-label" class="btn">Upload File(s)
        <input id="file-input" type="file" accept=".xlsx,.xls" multiple/>
      </label>
      <button id="upload-again" class="btn" style="display:none">Upload Again</button>
      <button id="clear-cache" class="btn" style="display:none;background:linear-gradient(90deg,#f87171,#ef4444)">Clear Cache</button>
      <div class="search">
        <input id="search-box" placeholder="🔍 Search BOQ No..."/>
      </div>
      <button id="create-mrn" class="btn" style="margin-top:10px">Create MRN</button>
    </div>
    <div class="table-wrap card" style="margin-top:10px;">
      <span class="tag" id="rows-count">0 rows</span>
      <div id="unique-container" class="unique-list"></div>
      <div id="table-scroll" style="max-height:500px;margin-top:6px;overflow:auto;">
        <table id="data-table"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
</div>

<script>
let rawData=[], headers=[], renderedCount=0;
const fileInput=document.getElementById('file-input');
const uploadLabel=document.getElementById('upload-label');
const uploadAgain=document.getElementById('upload-again');
const clearCache=document.getElementById('clear-cache');
const searchBox=document.getElementById('search-box');
const createMRNBtn=document.getElementById('create-mrn');
const rowsCount=document.getElementById('rows-count');
const dataTable=document.getElementById('data-table');
const uniqueContainer=document.getElementById('unique-container');
const tableScroll=document.getElementById('table-scroll');

function saveData(){
  localStorage.setItem("invData",JSON.stringify(rawData));
  localStorage.setItem("invHeaders",JSON.stringify(headers));
}

window.addEventListener("load",()=>{
  const savedData=localStorage.getItem("invData");
  const savedHeaders=localStorage.getItem("invHeaders");
  if(savedData && savedHeaders){
    rawData=JSON.parse(savedData);
    headers=JSON.parse(savedHeaders);
    rawData.forEach(r=>{
      if(!('_balance' in r)) r._balance = Number(r[headers[10]]||0);
    });
    showUniqueList();
    uploadLabel.style.display='none'; uploadAgain.style.display='block'; clearCache.style.display='block';
  }
});

fileInput.addEventListener('change', async ev => {
  const files = Array.from(ev.target.files);
  for (const f of files) {
    const buffer = await f.arrayBuffer();
    const wb = XLSX.read(buffer,{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    if(!json.length) continue;
    if(!headers.length) headers = json[0];

    rawData = rawData.filter(r => r._sourceFile !== f.name);

    const rows = json.slice(1).map(r=>{
      const obj=Object.fromEntries(headers.map((h,i)=>[h,r[i]]));
      obj._sourceFile = f.name;
      obj._balance = Number(obj[headers[10]]||0);
      return obj;
    });
    rawData = rawData.concat(rows);
  }
  saveData();
  showUniqueList();
  uploadLabel.style.display='none'; uploadAgain.style.display='block'; clearCache.style.display='block';
});

uploadAgain.addEventListener('click',()=>{
  fileInput.value=''; rawData=[]; headers=[];
  dataTable.querySelector('thead').innerHTML=''; dataTable.querySelector('tbody').innerHTML='';
  uniqueContainer.innerHTML='';
  localStorage.removeItem("invData"); localStorage.removeItem("invHeaders");
  uploadLabel.style.display='block'; uploadAgain.style.display='none'; clearCache.style.display='none';
  rowsCount.textContent='0 rows';
});

clearCache.addEventListener('click',()=>{ if(confirm("Clear saved data?")) uploadAgain.click(); });

searchBox.addEventListener('input', debounce(() => {
  const q = searchBox.value.trim().toLowerCase();
  if (!q) { showUniqueList(); return; }
  const results = rawData.filter(r => String(r[headers[0]] || '').toLowerCase().includes(q));
  renderTable(results, q, true);
}, 200));

function showUniqueList(){
  const uniqueMap = new Map();
  rawData.forEach(r => {
    const key = r[headers[0]];
    if(!uniqueMap.has(key)) uniqueMap.set(key, r);
  });
  uniqueContainer.innerHTML='';
  uniqueMap.forEach(r=>{
    const div=document.createElement('div');
    div.className='unique-item';
    div.textContent = r[headers[0]] + ' — ' + r[headers[3]];
    div.addEventListener('click',()=>{ filterByBOQ(r[headers[0]]); });
    uniqueContainer.appendChild(div);
  });
  dataTable.querySelector('thead').innerHTML='';
  dataTable.querySelector('tbody').innerHTML='';
  rowsCount.textContent=`${uniqueMap.size} unique BOQ`;
}

function filterByBOQ(boq){
  searchBox.value=boq;
  const results = rawData.filter(r => r[headers[0]] === boq);
  renderTable(results, boq, true);
}

function renderTable(rows, q='', reset=true){
  const thead=dataTable.querySelector('thead'), tbody=dataTable.querySelector('tbody');
  if(reset){ thead.innerHTML='<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'<th>Balance</th></tr>'; tbody.innerHTML=''; renderedCount=0; }
  const chunk = rows.slice(renderedCount, renderedCount+100);
  chunk.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = headers.map((h,i)=>{
      let val = String(r[h]||'');
      if(q && i===0){
        const re = new RegExp(`(${q})`,'gi');
        val = val.replace(re,'<mark>$1</mark>');
      }
      return `<td>${val}</td>`;
    }).join('') + `<td class="${r._balance===0?'zero-balance':''}">${r._balance}</td>`;
    tbody.appendChild(tr);
  });
  renderedCount += chunk.length;
  rowsCount.textContent=`${rows.length} rows (showing ${renderedCount})`;

  tableScroll.onscroll = () => {
    if(tableScroll.scrollTop + tableScroll.clientHeight >= tableScroll.scrollHeight-20){
      if(renderedCount < rows.length) renderTable(rows, q, false);
    }
  };
}

createMRNBtn.addEventListener('click',()=>{
  const boqNo = searchBox.value.trim();
  if(!boqNo) return alert("Please select/search a BOQ No first.");

  const items = rawData.filter(r=>r[headers[0]]===boqNo);
  if(!items.length) return alert("No items for this BOQ.");

  const modal = document.createElement('div');
  Object.assign(modal.style,{position:'fixed',top:'0',left:'0',width:'100%',height:'100%',background:'rgba(0,0,0,0.5)',display:'flex',justifyContent:'center',alignItems:'center',zIndex:9999});
  
  const content=document.createElement('div');
  Object.assign(content.style,{background:'#0b1220',padding:'15px',borderRadius:'10px',maxHeight:'80%',overflowY:'auto',width:'90%'});
  
  const table = document.createElement('table');
  table.style.width='100%';
  const thead = document.createElement('thead');
  thead.innerHTML='<tr><th><input type="checkbox" id="select-all"></th><th>Item ID</th><th>Description</th><th>BOQ Qty</th><th>Required Qty</th><th>Balance</th></tr>';
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  items.forEach(r=>{
    const tr = document.createElement('tr');
    const boqQty = r._balance;
    tr.innerHTML=`
      <td><input type="checkbox" class="select-item"></td>
      <td>${r[headers[6]]}</td>
      <td>${r[headers[7]]}</td>
      <td class="boq-qty">${boqQty}</td>
      <td><input type="number" class="req-qty" value="0" min="0" max="${boqQty}" style="width:60px"></td>
      <td class="balance">${boqQty}</td>
    `;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  content.appendChild(table);

  const generateBtn = document.createElement('button');
  generateBtn.textContent='Generate MRN Excel';
  Object.assign(generateBtn.style,{marginTop:'10px',padding:'8px',cursor:'pointer'});
  
  generateBtn.addEventListener('click',()=>{
    const selectedRows = Array.from(tbody.querySelectorAll('tr')).filter(tr=>tr.querySelector('.select-item').checked);
    if(!selectedRows.length) return alert("Select at least one item.");
    
    const mrnData=[['Item ID','Description','Required Qty']];
    selectedRows.forEach(tr=>{
      const id=tr.children[1].textContent;
      const desc=tr.children[2].textContent;
      const reqQty=Number(tr.querySelector('.req-qty').value);
      mrnData.push([id,desc,reqQty]);
      const item = rawData.find(r => r[headers[6]]===id && r[headers[0]]===boqNo);
      if(item){
        item._balance -= reqQty;
        if(item._balance <0) item._balance=0;
      }
      const boqQty=Number(tr.querySelector('.boq-qty').textContent);
      tr.querySelector('.balance').textContent=boqQty-reqQty;
    });

    renderTable(rawData.filter(r=>r[headers[0]]===boqNo), boqNo, true);

    const ws=XLSX.utils.aoa_to_sheet(mrnData);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'MRN');
    XLSX.writeFile(wb,'MRN.xlsx');
    saveData();
  });

  content.querySelector('#select-all').addEventListener('change',e=>{
    const checked=e.target.checked;
    tbody.querySelectorAll('.select-item').forEach(cb=>{
      cb.checked=checked;
      const tr=cb.closest('tr');
      const maxQty=Number(tr.querySelector('.boq-qty').textContent);
      tr.querySelector('.req-qty').value=checked? maxQty:0;
      tr.querySelector('.balance').textContent=checked?0:maxQty;
    });
  });

  content.appendChild(generateBtn);

  const closeBtn = document.createElement('button');
  closeBtn.textContent='Close';
  Object.assign(closeBtn.style,{marginTop:'10px',marginLeft:'10px',padding:'8px',cursor:'pointer',background:'#f87171',color:'#fff'});
  closeBtn.addEventListener('click',()=> modal.remove());
  content.appendChild(closeBtn);

  modal.appendChild(content);
  document.body.appendChild(modal);
});

function debounce(fn,delay=200){let t; return(...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),delay);};}
</script>
</body>
</html>
