<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Inventory Viewer</title>
<style>
:root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.08)}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#e6eef6;font-size:13px;background:linear-gradient(180deg,#021124 0%,#071326 100%);}
.wrap{max-width:100%;margin:0 auto;padding:10px}
h1{text-align:center;font-size:1rem;margin:0 0 8px}
.card{background:var(--card);border-radius:10px;padding:10px;box-shadow:0 3px 12px rgba(0,0,0,0.5);}
.controls{display:flex;flex-direction:column;gap:8px}
.btn{background:linear-gradient(90deg,var(--accent),#7dd3fc);border:none;padding:8px;border-radius:8px;color:#021124;font-weight:600;cursor:pointer;font-size:0.9rem;text-align:center}
input[type="file"]{display:none}
.search{position:relative}
.search input{width:100%;padding:12px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:var(--glass);color:inherit;font-size:1rem;}
.table-wrap{margin-top:10px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:0.8rem}
th,td{padding:6px 5px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05);word-wrap:break-word;white-space:normal;}
th{color:var(--muted);font-weight:600;position:sticky;top:0;background:var(--card);z-index:1}
mark{background:rgba(6,182,212,0.3);color:#fff;border-radius:2px;padding:0 1px}
.unique-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.unique-item{background:rgba(6,182,212,0.2);padding:6px 10px;border-radius:6px;cursor:pointer;user-select:none;}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>📊 Inventory Viewer</h1>
  <div class="card">
    <div class="controls">
      <label id="upload-label" class="btn">Upload File
        <input id="file-input" type="file" accept=".xlsx,.xls" multiple/>
      </label>
      <button id="upload-again" class="btn" style="display:none">Upload Again</button>
      <button id="clear-cache" class="btn" style="display:none;background:linear-gradient(90deg,#f87171,#ef4444)">Clear Cache</button>
      <div class="search">
        <input id="search-box" placeholder="🔍 Search BOQ No, Asset, Item..."/>
      </div>
    </div>
    <div class="table-wrap card" style="margin-top:10px;">
      <span class="tag" id="rows-count">0 rows</span>
      <div id="unique-container" class="unique-list"></div>
      <div id="table-scroll" style="max-height:500px;margin-top:6px;overflow:auto;">
        <table id="data-table"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
</div>

<script>
let rawData=[], headers=[], renderedCount=0;
const fileInput=document.getElementById('file-input');
const uploadLabel=document.getElementById('upload-label');
const uploadAgain=document.getElementById('upload-again');
const clearCache=document.getElementById('clear-cache');
const searchBox=document.getElementById('search-box');
const rowsCount=document.getElementById('rows-count');
const dataTable=document.getElementById('data-table');
const uniqueContainer=document.getElementById('unique-container');
const tableScroll=document.getElementById('table-scroll');

function saveData(){
  localStorage.setItem("invData",JSON.stringify(rawData));
  localStorage.setItem("invHeaders",JSON.stringify(headers));
}

// Restore saved data
window.addEventListener("load",()=>{
  const savedData=localStorage.getItem("invData");
  const savedHeaders=localStorage.getItem("invHeaders");
  if(savedData && savedHeaders){
    rawData=JSON.parse(savedData);
    headers=JSON.parse(savedHeaders);
    showUniqueList();
    uploadLabel.style.display='none'; uploadAgain.style.display='block'; clearCache.style.display='block';
  }
});

// Handle uploads
fileInput.addEventListener('change',async ev=>{
  const files=Array.from(ev.target.files);
  for(const f of files){
    const buffer=await f.arrayBuffer();
    const wb=XLSX.read(buffer,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    if(!json.length) continue;
    if(!headers.length) headers=json[0];

    // Remove old data from same file if exists
    const fileName=f.name;
    rawData=rawData.filter(r=>r._sourceFile!==fileName);

    // Map rows with _sourceFile
    const rows=json.slice(1).map(r=>{
      const obj=Object.fromEntries(headers.map((h,i)=>[h,r[i]]));
      obj._sourceFile=fileName;
      return obj;
    });
    rawData=rawData.concat(rows);
  }
  saveData();
  showUniqueList();
  uploadLabel.style.display='none'; uploadAgain.style.display='block'; clearCache.style.display='block';
});

uploadAgain.addEventListener('click',()=>{
  fileInput.value=''; rawData=[]; headers=[];
  dataTable.querySelector('thead').innerHTML=''; dataTable.querySelector('tbody').innerHTML='';
  uniqueContainer.innerHTML='';
  localStorage.removeItem("invData"); localStorage.removeItem("invHeaders");
  uploadLabel.style.display='block'; uploadAgain.style.display='none'; clearCache.style.display='none';
  rowsCount.textContent='0 rows';
});

clearCache.addEventListener('click',()=>{
  if(confirm("Clear saved data?")){
    uploadAgain.click();
  }
});

// Debounced search
searchBox.addEventListener('input',debounce(()=>{
  const q=searchBox.value.trim().toLowerCase();
  if(!q){ showUniqueList(); return; }
  const filterCols=[0,3,4,5,6,8,9,10];
  const results=rawData.filter(r=>filterCols.some(idx=>String(r[headers[idx]]||'').toLowerCase().includes(q)));
  renderTable(results,q,true);
},200));

function showUniqueList(){
  const uniqueMap=new Map();
  rawData.forEach(r=>{
    const key=r[headers[0]]+'|'+r[headers[3]]; // BOQ No | Asset/Service
    if(!uniqueMap.has(key)) uniqueMap.set(key,r);
  });
  uniqueContainer.innerHTML='';
  uniqueMap.forEach(r=>{
    const div=document.createElement('div');
    div.className='unique-item';
    div.textContent=`${r[headers[0]]} — ${r[headers[3]]}`;
    div.addEventListener('click',()=>{ filterByBOQ(r[headers[0]]); });
    uniqueContainer.appendChild(div);
  });
  dataTable.querySelector('thead').innerHTML='';
  dataTable.querySelector('tbody').innerHTML='';
  rowsCount.textContent=`${uniqueMap.size} unique BOQ`;
}

function filterByBOQ(boq){
  searchBox.value=boq;
  const results=rawData.filter(r=>r[headers[0]]===boq);
  renderTable(results,boq,true);
}

function renderTable(rows,q='',reset=true){
  const thead=dataTable.querySelector('thead'), tbody=dataTable.querySelector('tbody');
  if(reset){ thead.innerHTML='<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>'; tbody.innerHTML=''; renderedCount=0; }
  const chunk=rows.slice(renderedCount,renderedCount+100);
  chunk.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=headers.map((h,i)=>{
      let val=String(r[h]||'');
      if(q && [0,3,4,5,6,8,9,10].includes(i)){
        const re=new RegExp(`(${q})`,'gi');
        val=val.replace(re,'<mark>$1</mark>');
      }
      return `<td>${val}</td>`;
    }).join('');
    tbody.appendChild(tr);
  });
  renderedCount+=chunk.length;
  rowsCount.textContent=`${rows.length} rows (showing ${renderedCount})`;

  // Infinite scroll
  tableScroll.onscroll=()=>{
    if(tableScroll.scrollTop + tableScroll.clientHeight >= tableScroll.scrollHeight-20){
      if(renderedCount<rows.length){
        renderTable(rows,q,false);
      }
    }
  };
}

function debounce(fn,delay=200){let t; return(...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),delay);};}
</script>
</body>
</html>
