<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Inventory Viewer with MRN</title>
<style>
:root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.08)}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#e6eef6;font-size:13px;background:linear-gradient(180deg,#021124 0%,#071326 100%);}
.wrap{max-width:100%;margin:0 auto;padding:10px}
h1{text-align:center;font-size:1rem;margin:0 0 8px}
.card{background:var(--card);border-radius:10px;padding:10px;box-shadow:0 3px 12px rgba(0,0,0,0.5);}
.controls{display:flex;flex-direction:column;gap:8px}
.btn{background:linear-gradient(90deg,var(--accent),#7dd3fc);border:none;padding:8px;border-radius:8px;color:#021124;font-weight:600;cursor:pointer;font-size:0.9rem;text-align:center}
input[type="file"]{display:none}
.search{position:relative}
.search input{width:100%;padding:12px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:var(--glass);color:inherit;font-size:1rem;}
.table-wrap{margin-top:10px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:0.8rem}
th,td{padding:6px 5px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05);word-wrap:break-word;white-space:normal;}
th{color:var(--muted);font-weight:600;position:sticky;top:0;background:var(--card);z-index:1}
mark{background:rgba(6,182,212,0.3);color:#fff;border-radius:2px;padding:0 1px}
.unique-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
.unique-item{background:rgba(6,182,212,0.2);padding:6px 10px;border-radius:6px;cursor:pointer;user-select:none;}
.zero-balance{color:red;font-weight:600;}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>📊 Inventory Viewer (BOQ Only)</h1>
  <div class="card">
    <div class="controls">
      <label id="upload-label" class="btn">Upload File(s)
        <input id="file-input" type="file" accept=".xlsx,.xls" multiple/>
      </label>
      <button id="clear-cache" class="btn" style="display:none;background:linear-gradient(90deg,#f87171,#ef4444)">Clear Cache</button>
      <div class="search">
        <input id="search-box" placeholder="🔍 Search BOQ No..."/>
      </div>
      <button id="create-mrn" class="btn" style="margin-top:10px">Create MRN</button>
    </div>
    <div class="table-wrap card" style="margin-top:10px;">
      <span class="tag" id="rows-count">0 rows</span>
      <div id="unique-container" class="unique-list"></div>
      <div id="table-scroll" style="max-height:500px;margin-top:6px;overflow:auto;">
        <table id="data-table"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
</div>

<script>
let rawData=[], headers=[], renderedCount=0;
const fileInput=document.getElementById('file-input');
const uploadLabel=document.getElementById('upload-label');
const clearCache=document.getElementById('clear-cache');
const searchBox=document.getElementById('search-box');
const createMRNBtn=document.getElementById('create-mrn');
const rowsCount=document.getElementById('rows-count');
const dataTable=document.getElementById('data-table');
const uniqueContainer=document.getElementById('unique-container');
const tableScroll=document.getElementById('table-scroll');

function saveData(){
  localStorage.setItem("invData",JSON.stringify(rawData));
  localStorage.setItem("invHeaders",JSON.stringify(headers));
}

window.addEventListener("load",()=>{
  const savedData=localStorage.getItem("invData");
  const savedHeaders=localStorage.getItem("invHeaders");
  if(savedData && savedHeaders){
    rawData=JSON.parse(savedData);
    headers=JSON.parse(savedHeaders);
    rawData.forEach(r=>{
      if(!('_balance' in r)) r._balance = Number(r[headers[10]]||0);
    });
    showUniqueList();
    uploadLabel.style.display='none';
    clearCache.style.display='block';
  }
});

fileInput.addEventListener('change', async ev => {
  const files = Array.from(ev.target.files);
  for (const f of files) {
    const buffer = await f.arrayBuffer();
    const wb = XLSX.read(buffer,{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    if(!json.length) continue;
    if(!headers.length) headers = json[0];

    // Remove old data from same file
    rawData = rawData.filter(r => r._sourceFile !== f.name);

    const rows = json.slice(1).map(r=>{
      const obj=Object.fromEntries(headers.map((h,i)=>[h,r[i]]));
      obj._sourceFile = f.name;
      obj._balance = Number(obj[headers[10]]||0);
      return obj;
    });
    rawData = rawData.concat(rows);
  }
  saveData();
  showUniqueList();
  uploadLabel.style.display='none'; 
  clearCache.style.display='block';
});

clearCache.addEventListener('click',()=>{ 
  if(confirm("Clear saved data?")){
    rawData=[]; headers=[]; dataTable.querySelector('thead').innerHTML=''; dataTable.querySelector('tbody').innerHTML='';
    uniqueContainer.innerHTML=''; localStorage.removeItem("invData"); localStorage.removeItem("invHeaders");
    uploadLabel.style.display='block'; rowsCount.textContent='0 rows'; clearCache.style.display='none';
  }
});

searchBox.addEventListener('input', debounce(() => {
  const q = searchBox.value.trim().toLowerCase();
  if (!q) { showUniqueList(); return; }
  const results = rawData.filter(r => String(r[headers[0]] || '').toLowerCase().includes(q));
  renderTable(results, q, true);
}, 200));

function showUniqueList(){
  const uniqueMap = new Map();
  rawData.forEach(r => {
    const key = r[headers[0]];
    if(!uniqueMap.has(key)) uniqueMap.set(key, r);
  });
  uniqueContainer.innerHTML='';
  uniqueMap.forEach(r=>{
    const div=document.createElement('div');
    div.className='unique-item';
    div.textContent = r[headers[0]] + ' — ' + r[headers[3]];
    div.addEventListener('click',()=>{ filterByBOQ(r[headers[0]]); });
    uniqueContainer.appendChild(div);
  });
  dataTable.querySelector('thead').innerHTML='';
  dataTable.querySelector('tbody').innerHTML='';
  rowsCount.textContent=`${uniqueMap.size} unique BOQ`;
}

function filterByBOQ(boq){
  searchBox.value=boq;
  const results = rawData.filter(r => r[headers[0]] === boq);
  renderTable(results, boq, true);
}

function renderTable(rows, q='', reset=true){
  const thead=dataTable.querySelector('thead'), tbody=dataTable.querySelector('tbody');
  if(reset){
    // Hide columns L M N O
    const visibleHeaders = headers.filter((h,i)=>i<11);
    thead.innerHTML='<tr>'+visibleHeaders.map(h=>`<th>${h}</th>`).join('')+'<th>Balance</th><th>Total MRN Qty</th></tr>';
    tbody.innerHTML=''; renderedCount=0;
  }
  const chunk = rows.slice(renderedCount, renderedCount+100);
  chunk.forEach(r=>{
    const tr = document.createElement('tr');
    let totalMRN = r._totalMRN||0;
    const tds = headers.filter((h,i)=>i<11).map((h,i)=>{
      let val = String(r[h]||'');
      if(q && i===0){
        const re = new RegExp(`(${q})`,'gi');
        val = val.replace(re,'<mark>$1</mark>');
      }
      return `<td>${val}</td>`;
    }).join('');
    tr.innerHTML = tds + `<td class="${r._balance===0?'zero-balance':''}">${r._balance}</td><td>${totalMRN}</td>`;
    tbody.appendChild(tr);
  });
  renderedCount += chunk.length;
  rowsCount.textContent=`${rows.length} rows (showing ${renderedCount})`;

  tableScroll.onscroll = () => {
    if(tableScroll.scrollTop + tableScroll.clientHeight >= tableScroll.scrollHeight-20){
      if(renderedCount < rows.length) renderTable(rows, q, false);
    }
  };
}

createMRNBtn.addEventListener('click',()=>{
  const boq = searchBox.value.trim();
  if(!boq){ alert('Search a BOQ first!'); return; }
  const items = rawData.filter(r=>r[headers[0]]===boq);
  if(!items.length) return;

  // Modal
  const modal = document.createElement('div');
  Object.assign(modal.style,{position:'fixed',top:0,left:0,width:'100%',height:'100%',background:'rgba(0,0,0,0.6)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999});
  const content = document.createElement('div');
  Object.assign(content.style,{background:'#fff',padding:'20px',borderRadius:'10px',maxHeight:'80%',overflow:'auto',width:'90%',maxWidth:'600px',color:'#000'});
  const title = document.createElement('h2'); title.textContent='Create MRN — ' + boq; content.appendChild(title);

  const table = document.createElement('table'); table.style.width='100%';
  const thead = document.createElement('thead'); thead.innerHTML='<tr><th>Select</th><th>Item</th><th>BOQ Qty</th><th>Required Qty</th><th>Balance</th></tr>';
  table.appendChild(thead);
  const tbody = document.createElement('tbody');

  items.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="mrn-select"></td>
      <td>${r[headers[7]]}</td>
      <td class="boq-qty">${r._balance}</td>
      <td><input type="number" class="req-qty" value="0" style="width:60px"/></td>
      <td class="balance">${r._balance}</td>
    `;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  content.appendChild(table);

  // Select All + Generate
  const selectAllBtn = document.createElement('button'); selectAllBtn.textContent='Select All'; Object.assign(selectAllBtn.style,{marginTop:'10px',padding:'8px'});
  selectAllBtn.addEventListener('click',()=>{
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.querySelector('.mrn-select').checked=true;
      const maxQty=Number(tr.querySelector('.boq-qty').textContent);
      tr.querySelector('.req-qty').value=maxQty;
      tr.querySelector('.balance').textContent=0;
    });
  });
  content.appendChild(selectAllBtn);

  const generateBtn = document.createElement('button'); generateBtn.textContent='Generate MRN'; Object.assign(generateBtn.style,{marginTop:'10px',marginLeft:'10px',padding:'8px',background:'#06b6d4',color:'#fff'});
  generateBtn.addEventListener('click',()=>{
    const mrnData = [];
    tbody.querySelectorAll('tr').forEach((tr,i)=>{
      const checked = tr.querySelector('.mrn-select').checked;
      const reqQty = Number(tr.querySelector('.req-qty').value)||0;
      if(checked && reqQty>0){
        mrnData.push({
          'BOQ No': items[i][headers[0]],
          'Item Description': items[i][headers[7]],
          'Required Qty': reqQty
        });
        // Update balance
        items[i]._balance -= reqQty;
        items[i]._totalMRN = (items[i]._totalMRN||0) + reqQty;
      }
    });
    if(!mrnData.length){ alert('No items selected'); return; }

    // Generate Excel
    const ws = XLSX.utils.json_to_sheet(mrnData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'MRN');
    XLSX.writeFile(wb, 'MRN.xlsx');
    renderTable(items, searchBox.value, true);
    alert('MRN generated and balances updated!');
  });
  content.appendChild(generateBtn);

  const closeBtn = document.createElement('button'); closeBtn.textContent='Close';
  Object.assign(closeBtn.style,{marginTop:'10px',marginLeft:'10px',padding:'8px',cursor:'pointer',background:'#f87171',color:'#fff'});
  closeBtn.addEventListener('click',()=> modal.remove());
  content.appendChild(closeBtn);

  modal.appendChild(content); document.body.appendChild(modal);
});

function debounce(fn,delay=200){let t; return(...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),delay);};}
</script>
</body>
</html>
